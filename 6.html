<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>デザインパターン2 第六章</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-gH2yIJqKdNHPEq0n4Mqa/HGKIhSkIHeL5AyhkYV8i59U5AR6csBvApHHNl/vI1Bx" crossorigin="anonymous">
    <link rel="stylesheet" href="../css/template.css">
    <script src="../js/template.js"></script>
  </head>

    <body>
      
      <div id="box">
      </div>
      <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js">
      </script>
      <script>
        jQuery(function(){
          $('#box').load('html/header.html') // #headerにheader.htmlを読み込む
        });
      </script>
      <div class="title">
        <h1>第六章 Stateパターン</h1>
      </div>
      <div class="letter-body">
        <ul id="list1">
          <li id="1"><h2 class="margin-letter2">6.1 FSM(有限状態機械)</h2></li>
          <div class="letter">
            <div>
                Stateパターンの説明の前に、FSM(有限状態機械)の説明を行いたいと思います。
                <div class="margin-letter">
                    アクションゲームの開発をしているとしましょう。
                    Spaceキーを押せば、ジャンプです。簡単ですね。
                </div>
                <div class="margin-letter">
                  <code>
                    <ol class="code-region row coll-11">
                    <li>void Actor::HandleInput()</li>
                    <li>{</li>
                    <li>&nbsp;&nbsp;&nbsp;&nbsp;<font style="color:lightgreen;font-style:italic;">//Bボタンが押されたら。</font></li>
                    <li>&nbsp;&nbsp;&nbsp;&nbsp;if (IsButtonDown(B))</li>
                    <li>&nbsp;&nbsp;&nbsp;&nbsp;{</li>
                    <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font style="color:lightgreen;font-style:italic;">//上に移動させる。</font></li>
                    <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;m_velocity.y = JUMP_VELOCITY;</li>
                    <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font style="color:lightgreen;font-style:italic;">//ジャンプアニメーションを再生させる。</font></li>
                    <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SetAnimation(Jump);</li>
                    <li>&nbsp;&nbsp;&nbsp;&nbsp;}</li>
                    <li>}</li>
                    </ol></code>
                </div>
                <div class="margin-letter">
                  しかし、これだけでは<span class="strong-letter">ジャンプ中にも関わらずジャンプが出来てしまいます。</span>
                  そこで、ジャンプ中かどうかを判断するフラグを追加しましょう。
                </div>
                <div class="margin-letter">
                  <code>
                    <ol class="code-region row coll-11">
                    <li>void Actor::HandleInput()</li>
                    <li>{</li>
                    <li>&nbsp;&nbsp;&nbsp;&nbsp;<font style="color:lightgreen;font-style:italic;">//Bボタンが押されたら。</font></li>
                    <li>&nbsp;&nbsp;&nbsp;&nbsp;if (IsButtonDown(B))</li>
                    <li>&nbsp;&nbsp;&nbsp;&nbsp;{</li>
                    <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font style="color:lightgreen;font-style:italic;">//ジャンプ中ではなかったら。</font></li>
                    <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (m_isJump == false)</li>
                    <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</li>
                    <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font style="color:lightgreen;font-style:italic;">//上に移動させる。</font></li>
                    <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;m_velocity.y = JUMP_VELOCITY;</li>
                    <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font style="color:lightgreen;font-style:italic;">//ジャンプアニメーションを再生させる。</font></li>
                    <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SetAnimation(Jump);</li>
                    <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font style="color:lightgreen;font-style:italic;">//ジャンプフラグをtrueに。</font></li>
                    <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;m_isJump = true;</li>
                    <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</li>
                    <li>&nbsp;&nbsp;&nbsp;&nbsp;}</li>
                    <li>}</li>
                    </ol></code>
                </div>
                <div class="margin-letter">
                  次に、プレイヤーが地上に居る時にボタンを押すとプレイヤーがしゃがみ、ボタンを放すと直立姿勢に戻るようにしましょう。
                </div>
                <div class="margin-letter">
                  <code>
                    <ol class="code-region row coll-11">
                    <li>void Actor::HandleInput()</li>
                    <li>{</li>
                    <li>&nbsp;&nbsp;&nbsp;&nbsp;<font style="color:lightgreen;font-style:italic;">//Bボタンが押されたら。</font></li>
                    <li>&nbsp;&nbsp;&nbsp;&nbsp;if (IsButtonDown(B))</li>
                    <li>&nbsp;&nbsp;&nbsp;&nbsp;{</li>
                    <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font style="color:lightgreen;font-style:italic;">//ジャンプ中ではなかったら。</font></li>
                    <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (m_isJump == false)</li>
                    <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</li>
                    <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font style="color:lightgreen;font-style:italic;">//上に移動させる。</font></li>
                    <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;m_velocity.y = JUMP_VELOCITY;</li>
                    <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font style="color:lightgreen;font-style:italic;">//ジャンプアニメーションを再生させる。</font></li>
                    <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SetAnimation(Jump);</li>
                    <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font style="color:lightgreen;font-style:italic;">//ジャンプフラグをtrueに。</font></li>
                    <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;m_isJump = true;</li>
                    <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</li>
                    <li>&nbsp;&nbsp;&nbsp;&nbsp;}</li>
                    <li>&nbsp;&nbsp;&nbsp;&nbsp;<font style="color:lightgreen;font-style:italic;">//下ボタンが押されたら。</font></li>
                    <li>&nbsp;&nbsp;&nbsp;&nbsp;else if (IsButtonPress(Down))</li>
                    <li>&nbsp;&nbsp;&nbsp;&nbsp;{</li>
                    <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font style="color:lightgreen;font-style:italic;">//ジャンプ中でないなら。</font></li>
                    <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (m_isJump == false)</li>
                    <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</li>
                    <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font style="color:lightgreen;font-style:italic;">//屈むアニメーションを再生する。</font></li>
                    <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SetAnimation(Duck);</li>
                    <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</li>
                    <li>&nbsp;&nbsp;&nbsp;&nbsp;}</li>
                    <li>&nbsp;&nbsp;&nbsp;&nbsp;<font style="color:lightgreen;font-style:italic;">//下ボタンが離されたら。</font></li>
                    <li>&nbsp;&nbsp;&nbsp;&nbsp;else if (IsButtonRelease(Down))</li>
                    <li>&nbsp;&nbsp;&nbsp;&nbsp;{</li>
                    <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font style="color:lightgreen;font-style:italic;">//直立姿勢アニメーションを再生する。</font></li>
                    <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SetAnimation(Stand);</li>
                    <li>&nbsp;&nbsp;&nbsp;&nbsp;}</li>
                    <li>}</li>
                    </ol></code>
                </div>
                <div class="margin-letter">
                  しかし、これでは以下のようなことが起こってしまいます。
                  <ul>
                    <li>下ボタンで屈む。</li>
                    <li>Bボタンでジャンプ。</li>
                    <li>ジャンプ中に下ボタンを離す(<span class="strong-letter">直立姿勢のアニメーションが再生されてしまう</span>)。</li>
                  </ul>
                  これを避けるために、屈んでいるかどうかを判断するフラグを追加しましょう。
                </div>
                <div class="margin-letter">
                  <code>
                    <ol class="code-region row coll-11">
                    <li>void Actor::HandleInput()</li>
                    <li>{</li>
                    <li>&nbsp;&nbsp;&nbsp;&nbsp;<font style="color:lightgreen;font-style:italic;">//Bボタンが押されたら。</font></li>
                    <li>&nbsp;&nbsp;&nbsp;&nbsp;if (IsButtonDown(B))</li>
                    <li>&nbsp;&nbsp;&nbsp;&nbsp;{</li>
                    <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font style="color:lightgreen;font-style:italic;">//ジャンプ中ではないかつ屈み中ではなかったら。</font></li>
                    <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (m_isJump == false &amp;&amp; m_isDucking == false)</li>
                    <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</li>
                    <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font style="color:lightgreen;font-style:italic;">//上に移動させる。</font></li>
                    <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;m_velocity.y = JUMP_VELOCITY;</li>
                    <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font style="color:lightgreen;font-style:italic;">//ジャンプアニメーションを再生させる。</font></li>
                    <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SetAnimation(Jump);</li>
                    <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font style="color:lightgreen;font-style:italic;">//ジャンプフラグをtrueにする。</font></li>
                    <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;m_isJump = true;</li>
                    <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</li>
                    <li>&nbsp;&nbsp;&nbsp;&nbsp;}</li>
                    <li>&nbsp;&nbsp;&nbsp;&nbsp;<font style="color:lightgreen;font-style:italic;">//下ボタンが押されたら。</font></li>
                    <li>&nbsp;&nbsp;&nbsp;&nbsp;else if (IsButtonPress(Down))</li>
                    <li>&nbsp;&nbsp;&nbsp;&nbsp;{</li>
                    <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font style="color:lightgreen;font-style:italic;">//ジャンプ中でないなら。</font></li>
                    <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (m_isJump == false)</li>
                    <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</li>
                    <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font style="color:lightgreen;font-style:italic;">//屈むアニメーションを再生する。</font></li>
                    <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SetAnimation(Duck);</li>
                    <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font style="color:lightgreen;font-style:italic;">//屈みフラグをtrueにする。</font></li>
                    <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;m_isDucking = true;</li>
                    <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</li>
                    <li>&nbsp;&nbsp;&nbsp;&nbsp;}</li>
                    <li>&nbsp;&nbsp;&nbsp;&nbsp;<font style="color:lightgreen;font-style:italic;">//下ボタンが離されたら。</font></li>
                    <li>&nbsp;&nbsp;&nbsp;&nbsp;else if (IsButtonRelease(Down))</li>
                    <li>&nbsp;&nbsp;&nbsp;&nbsp;{</li>
                    <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font style="color:lightgreen;font-style:italic;">//屈み中なら。</font></li>
                    <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (m_isDucking)</li>
                    <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</li>
                    <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font style="color:lightgreen;font-style:italic;">//屈みフラグをfalseにする。</font></li>
                    <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;m_isDucking = false;</li>
                    <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font style="color:lightgreen;font-style:italic;">//直立姿勢アニメーションを再生する。</font></li>
                    <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SetAnimation(Stand);</li>
                    <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</li>
                    <li>&nbsp;&nbsp;&nbsp;&nbsp;}</li>
                    <li>}</li>
                    </ol></code>
                </div>
                <div class="margin-letter">
                  <ul>
                    <li>ジャンプ</li>
                    <li>屈み</li>
                    <li>立ち</li>
                  </ul>
                  この3つの状態を実装するだけでも、if文とフラグが乱雑になり、分かりにくいプログラムになってしまいました。
                  更に攻撃や移動の状態を追加するとなると、非常に面倒なことになるのは誰の目にも明かでしょう。
                </div>
                <div class="margin-letter">
                  この分かりにくいプログラムを改善するために、プレイヤーの状態を一旦整理してみましょう。
                </div>
                <div>
                  <img src="image/5/1.png" class="margin-letter">
                </div>
                <div class="margin-letter">
                  これがFSM(有限状態機械)です。FSMの要点は以下の通りです。
                  <ul>
                    <h5>
                      <li>機械のとることのできる固定の状態がある。</li>
                      <li>機械は一度に1つの状態しかとることができない。</li>
                      <li>一連の入力もしくはイベントが機械に与えられる。</li>
                      <li>各状態は遷移に集合を持ち、入力に応じて状態を遷移する。</li>
                    </h5>
                  </ul>
                </div>
                <div class="margin-letter">
                  <span class="strong-letter">状態・入力・遷移</span>、これが全てです。
                  これを実装するための方法の1つがStateパターンになるのですが、その前に簡単なプログラムから実装してみましょう。
                </div>
                <div class="margin-letter">
                  今までのプレイヤーは複数のフラグの組み合わせで、状態を表していました。
                  これを、enum(列挙型)で表すようにしましょう。
                </div>
                <div class="margin-letter">
                  <code>
                    <ol class="code-region row coll-11">
                    <li>enum</li>
                    <li>{</li>
                    <li>&nbsp;&nbsp;&nbsp;&nbsp;STATE_STANDING,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font style="color:lightgreen;font-style:italic;">//立ち</font></li>
                    <li>&nbsp;&nbsp;&nbsp;&nbsp;STATE_JUMPING,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font style="color:lightgreen;font-style:italic;">//ジャンプ</font></li>
                    <li>&nbsp;&nbsp;&nbsp;&nbsp;STATE_DUCKING,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font style="color:lightgreen;font-style:italic;">//屈み</font></li>
                    <li>};</li>
                    </ol></code>
                </div>
                <div class="margin-letter">
                  プレイヤーは沢山のフラグを保持していましたが、代わりにたった一つの変数m_stateがあるだけになります。
                  また、以前のコードでは、入力→状態と分岐していました。なので、1つの状態に関するコードが、あちこちに分散していまいました。
                  なので、最初に状態の分岐を行うようにします。
                </div>
                <div class="margin-letter">
                  <code>
                    <ol class="code-region row coll-11">
                    <li>void Actor::HandleInput()</li>
                    <li>{</li>
                    <li>&nbsp;&nbsp;&nbsp;&nbsp;switch (m_state)</li>
                    <li>&nbsp;&nbsp;&nbsp;&nbsp;{</li>
                    <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font style="color:lightgreen;font-style:italic;">//立ち状態の場合。</font></li>
                    <li>&nbsp;&nbsp;&nbsp;&nbsp;case STATE_STANDING:</li>
                    <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (IsPressButton(B))</li>
                    <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</li>
                    <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font style="color:lightgreen;font-style:italic;">//上に移動させる。</font></li>
                    <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;m_velocity.y = JUMP_VELOCITY;</li>
                    <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font style="color:lightgreen;font-style:italic;">//ジャンプアニメーションを再生させる。</font></li>
                    <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SetAnimation(Jump);</li>
                    <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font style="color:lightgreen;font-style:italic;">//ステートをジャンプに。</font></li>
                    <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;m_state = STATE_JUMPING;</li>
                    <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</li>
                    <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else if (IsPressButton(Down))</li>
                    <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</li>
                    <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font style="color:lightgreen;font-style:italic;">//屈むアニメーションを再生する。</font></li>
                    <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SetAnimation(Duck);</li>
                    <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font style="color:lightgreen;font-style:italic;">//ステートを屈みに。</font></li>
                    <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;m_state = STATE_DUCKING;</li>
                    <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</li>
                    <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;</li>
                    <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font style="color:lightgreen;font-style:italic;">//屈み状態の場合。</font></li>
                    <li>&nbsp;&nbsp;&nbsp;&nbsp;case STATE_DUCKING:</li>
                    <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (IsReleaseButton(Down))</li>
                    <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</li>
                    <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font style="color:lightgreen;font-style:italic;">//直立姿勢アニメーションを再生する。</font></li>
                    <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SetAnimation(Stand);</li>
                    <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font style="color:lightgreen;font-style:italic;">//ステートを立ちに。</font></li>
                    <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;m_state = STATE_STANDING;</li>
                    <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</li>
                    <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;</li>
                    <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font style="color:lightgreen;font-style:italic;">//ジャンプ状態の場合。</font></li>
                    <li>&nbsp;&nbsp;&nbsp;&nbsp;case STATE_JUMPING:</li>
                    <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font style="color:lightgreen;font-style:italic;">//...</font></li>
                    <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;</li>
                    <li>&nbsp;&nbsp;&nbsp;&nbsp;}</li>
                    <li>}</li>
                    </ol></code>
                </div>
                <div class="margin-letter">
                  大した変化ではないかもしれませんが、以前のコードに比べて格段に進歩しました。
                  複数のフラグを変更可能な1つの変数m_stateにまとめることができました。
                </div>
              </div>
          </div>
          <li id="2"><h2 class="margin-letter2">6.2 練習問題1</h2></li>
          <div class="letter">
            <div>
              practice/State/Practice1/Game.slnからVisualStudioを立ち上げてください。
              実行すると、このようになります。Fキーで攻撃、Spaceキーでジャンプです。
              <div>
                <img src="image/5/2.png" class="margin-letter">
              </div>
              <span class="strong-letter">Actorクラスを改造して、立ち・ジャンプ・攻撃をenum(列挙型)とswitch文での実装に変更してください。</span>
              <ul>
                <li>Answerに実装例がありますので、参考にしてください。</li>
              </ul>
            </div>
          </div>
          <li id="3"><h2 class="margin-letter2">6.3 Stateパターン</h2></li>
          <div class="letter">
            <div>
              上記が、状態機械を実装する最も単純な方法であり、場合によってはこの実装でも申し分ありません。
              しかし、上記の単純な実装方法では解決しきれない問題が、時に現れるかもしれません。
              <div class="margin-letter">
                例えば、<span class="strong-letter">プレイヤーが屈み状態の時に、パワーをチャージして特別なチャージ・アタックする動きを追加したい</span>としたらどうでしょうか。
                チャージする時間を計るためのタイマーが必要になります。そして、毎フレーム実行されているUpdate関数があるとすれば、そこに次のようにコードを追加するでしょう。
              </div>
              <div class="margin-letter">
                <code>
                  <ol class="code-region row coll-11">
                  <li><font style="color:lightgreen;font-style:italic;">//毎フレーム実行されるUpdate関数。</font></li>
                  <li>void Actor::Update()</li>
                  <li>{</li>
                  <li>&nbsp;&nbsp;&nbsp;&nbsp;<font style="color:lightgreen;font-style:italic;">//屈み状態なら。</font></li>
                  <li>&nbsp;&nbsp;&nbsp;&nbsp;if (m_state == STATE_DUCKING)</li>
                  <li>&nbsp;&nbsp;&nbsp;&nbsp;{</li>
                  <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font style="color:lightgreen;font-style:italic;">//チャージタイムを＋する。</font></li>
                  <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;m_chargeTime++;</li>
                  <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font style="color:lightgreen;font-style:italic;">//チャージタイムが一定時間を超えれば。</font></li>
                  <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (m_chargeTime &gt;= MAX_CHARGE)</li>
                  <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</li>
                  <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font style="color:lightgreen;font-style:italic;">//特別なチャージ・アタックをする。</font></li>
                  <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ChargeAttack();</li>
                  <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</li>
                  <li>&nbsp;&nbsp;&nbsp;&nbsp;}</li>
                  <li>}</li>
                  </ol></code>
              </div>
              <div class="margin-letter">
                また、屈み始めた時には、タイマーをリセットする必要があります。
              </div>
              <div class="margin-letter">
                <code>
                  <ol class="code-region row coll-11">
                  <li>void Actor::HandleInput()</li>
                  <li>{</li>
                  <li>&nbsp;&nbsp;&nbsp;&nbsp;switch (m_state)</li>
                  <li>&nbsp;&nbsp;&nbsp;&nbsp;{</li>
                  <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font style="color:lightgreen;font-style:italic;">//立ち状態の場合。</font></li>
                  <li>&nbsp;&nbsp;&nbsp;&nbsp;case STATE_STANDING:</li>
                  <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (IsPressButton(B))</li>
                  <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</li>
                  <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font style="color:lightgreen;font-style:italic;">//上に移動させる。</font></li>
                  <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;m_velocity.y = JUMP_VELOCITY;</li>
                  <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font style="color:lightgreen;font-style:italic;">//ジャンプアニメーションを再生させる。</font></li>
                  <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SetAnimation(Jump);</li>
                  <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font style="color:lightgreen;font-style:italic;">//ステートをジャンプに。</font></li>
                  <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;m_state = STATE_JUMPING;</li>
                  <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</li>
                  <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else if (IsPressButton(Down))</li>
                  <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</li>
                  <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font style="color:lightgreen;font-style:italic;">//屈むアニメーションを再生する。</font></li>
                  <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SetAnimation(Duck);</li>
                  <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font style="color:lightgreen;font-style:italic;">//ステートを屈みに。</font></li>
                  <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;m_state = STATE_DUCKING;</li>
                  <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: red;border-bottom:solid 1px red;font-weight:bold;"><font style="color:lightgreen;font-style:italic;">//チャージタイムを0に。</span></font></li>
                  <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: red;border-bottom:solid 1px red;font-weight:bold;">m_chargeTime = 0;</span></li>
                  <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</li>
                  <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;</li>
                  <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font style="color:lightgreen;font-style:italic;">//屈み状態の場合。</font></li>
                  <li>&nbsp;&nbsp;&nbsp;&nbsp;case STATE_DUCKING:</li>
                  <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font style="color:lightgreen;font-style:italic;">//....</font></li>
                  <li>&nbsp;&nbsp;&nbsp;&nbsp;}</li>
                  <li>}</li>
                  </ol></code>
              </div>
              <div class="margin-letter">
                この特別なチャージ・アタックを追加するために、2つのメソッドを修正しm_chargeTimeを追加しなければなりませんでした。
                この攻撃が屈んでいる状態のときにしか有効ではないにも関わらずです。本当は、こういったコードとデータがまとまっていた方がいいのです。
                ここでStateパターンが役に立ちます。
              </div> 
              <div class="margin-letter">
                まず、基底クラスであるStateクラスを宣言します。
              </div>
              <div class="margin-letter">
                <code>
                  <ol class="code-region row coll-11">
                  <li><font style="color:lightgreen;font-style:italic;">//Stateクラス。</font></li>
                  <li>class ActorState</li>
                  <li>{</li>
                  <li>public:</li>
                  <li>&nbsp;&nbsp;&nbsp;&nbsp;virtual ~ActorState() {}</li>
                  <li>&nbsp;&nbsp;&nbsp;&nbsp;<font style="color:lightgreen;font-style:italic;">//ステートが移行された際に、最初に実行される処理(入口処理)。</font></li>
                  <li>&nbsp;&nbsp;&nbsp;&nbsp;virtual void Enter(Actor* actor) = 0;</li>
                  <li>&nbsp;&nbsp;&nbsp;&nbsp;<font style="color:lightgreen;font-style:italic;">//入力により、ステートを移行させる処理。</font></li>
                  <li>&nbsp;&nbsp;&nbsp;&nbsp;virtual ActorState* HandleInput(Actor* actor) = 0;</li>
                  <li>&nbsp;&nbsp;&nbsp;&nbsp;<font style="color:lightgreen;font-style:italic;">//Actorから毎フレーム呼ばれる処理。</font></li>
                  <li>&nbsp;&nbsp;&nbsp;&nbsp;virtual void Update(Actor* actor) = 0;</li>
                  <li>};</li>
                  </ol></code>
              </div>
              <div class="margin-letter">
                続いて、派生クラスを下記のように定義します。
              </div>
              <div class="margin-letter">
                <code>
                  <ol class="code-region row coll-11">
                  <li><font style="color:lightgreen;font-style:italic;">//屈みステート。</font></li>
                  <li>class DuckingState : public ActorState</li>
                  <li>{</li>
                  <li>public:</li>
                  <li>&nbsp;&nbsp;&nbsp;&nbsp;~DuckingState override {}</li>
                  <li></li>
                  <li>&nbsp;&nbsp;&nbsp;&nbsp;<font style="color:lightgreen;font-style:italic;">//ステートが移行された際に、最初に呼ばれる処理(入口処理)。</font></li>
                  <li>&nbsp;&nbsp;&nbsp;&nbsp;void Enter(Actor* actor) override</li>
                  <li>&nbsp;&nbsp;&nbsp;&nbsp;{</li>
                  <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font style="color:lightgreen;font-style:italic;">//屈みアニメーションを再生する。</font></li>
                  <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;actor-&gt;SetAnimation(Duck);</li>
                  <li>&nbsp;&nbsp;&nbsp;&nbsp;}</li>
                  <li></li>
                  <li>&nbsp;&nbsp;&nbsp;&nbsp;<font style="color:lightgreen;font-style:italic;">//入力に対して、ステートを移行させる処理。</font></li>
                  <li>&nbsp;&nbsp;&nbsp;&nbsp;ActorState* HandleInput(Actor* actor) override</li>
                  <li>&nbsp;&nbsp;&nbsp;&nbsp;{</li>
                  <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font style="color:lightgreen;font-style:italic;">//下ボタンが離されたら。</font></li>
                  <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (IsReleaseButton(Down))</li>
                  <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</li>
                  <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font style="color:lightgreen;font-style:italic;">//立ちステートを返す。</font></li>
                  <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return new StandingState();</li>
                  <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</li>
                  <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font style="color:lightgreen;font-style:italic;">//ステートを移行しない。</font></li>
                  <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return nullptr;</li>
                  <li>&nbsp;&nbsp;&nbsp;&nbsp;}</li>
                  <li></li>
                  <li>&nbsp;&nbsp;&nbsp;&nbsp;<font style="color:lightgreen;font-style:italic;">//Actorから毎フレーム呼ばれる処理。</font></li>
                  <li>&nbsp;&nbsp;&nbsp;&nbsp;void Update(Actor* actor) override</li>
                  <li>&nbsp;&nbsp;&nbsp;&nbsp;{</li>
                  <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font style="color:lightgreen;font-style:italic;">//チャージタイムを＋する。</font></li>
                  <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;m_chargeTime++;</li>
                  <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font style="color:lightgreen;font-style:italic;">//チャージタイムが一定時間を超えれば。</font></li>
                  <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (m_chargeTime &gt;= MAX_CHARGE)</li>
                  <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</li>
                  <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font style="color:lightgreen;font-style:italic;">//特別なチャージ・アタックをする。</font></li>
                  <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;actor-&gt;ChargeAttack();</li>
                  <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</li>
                  <li>&nbsp;&nbsp;&nbsp;&nbsp;}</li>
                  <li>private:</li>
                  <li>&nbsp;&nbsp;&nbsp;&nbsp;int m_chargeTime = 0;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font style="color:lightgreen;font-style:italic;">//チャージ時間を計る。</font></li>
                  <li>};</li>
                  <li></li>
                  <li><font style="color:lightgreen;font-style:italic;">//ジャンプステート。</font></li>
                  <li>class JumpState : public ActorState</li>
                  <li>{</li>
                  <li>&nbsp;&nbsp;&nbsp;&nbsp;<font style="color:lightgreen;font-style:italic;">//...</font></li>
                  <li>};</li>
                  </ol></code>
              </div>
              <div class="margin-letter">
                m_chargeTimeをDuckingStateクラスに移動させたことに注意してください。これはとても良いことです。m_chargeTimeは、屈み状態でしか意味をなさなかったのですから。
                <br>Actorクラスでは、Stateクラスをこのように活用します。switch文を無くし、Stateクラスに処理を委任します。
              </div>
              <div class="margin-letter">
                <code>
                  <ol class="code-region row coll-11">
                  <li>class Actor</li>
                  <li>{</li>
                  <li>public:</li>
                  <li>&nbsp;&nbsp;&nbsp;&nbsp;void HandleInput()</li>
                  <li>&nbsp;&nbsp;&nbsp;&nbsp;{</li>
                  <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ActorState* actorState = m_actorState-&gt;HandleInput(this);</li>
                  <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font style="color:lightgreen;font-style:italic;">//nullじゃなかったら。</font></li>
                  <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (actorState != nullptr)</li>
                  <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</li>
                  <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font style="color:lightgreen;font-style:italic;">//現在のステートを削除する。</font></li>
                  <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;delete m_actorState;</li>
                  <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font style="color:lightgreen;font-style:italic;">//ステートを移行する。</font></li>
                  <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;m_actorState = actorState;</li>
                  <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;m_actorState-&gt;Enter(this);</li>
                  <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</li>
                  <li>&nbsp;&nbsp;&nbsp;&nbsp;}</li>
                  <li>&nbsp;&nbsp;&nbsp;&nbsp;<font style="color:lightgreen;font-style:italic;">//毎フレーム呼ばれる処理。</font></li>
                  <li>&nbsp;&nbsp;&nbsp;&nbsp;void Update()</li>
                  <li>&nbsp;&nbsp;&nbsp;&nbsp;{</li>
                  <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;m_state-&gt;Update(this);</li>
                  <li>&nbsp;&nbsp;&nbsp;&nbsp;}</li>
                  <li>};</li>
                  </ol></code>
              </div>
              <div class="margin-letter">
                状態を変えるには、Stateポインタに異なるStateポインタを挿入するだけです。
                <br>如何でしょうか。チャージ・アタックの実装を、屈みステート内で行う事に成功しました。
              </div>
            </div>
          </div>
          <li id="4"><h2 class="margin-letter2">6.4 練習問題2</h2></li>
          <div class="letter">
            <div>
              practice/State/Practice1/Game.slnからVisualStudioを立ち上げてください。
              練習問題同じように、SpaceキーでActorがジャンプ・Fキーで攻撃を行います。
              Actor::Update()が下記のように実装されています。
              <div class="margin-letter">
                <code>
                  <ol class="code-region row coll-11">
                  <li>void Actor::Update()</li>
                  <li>{</li>
                  <li>&nbsp;&nbsp;&nbsp;&nbsp;switch (m_state)</li>
                  <li>&nbsp;&nbsp;&nbsp;&nbsp;{</li>
                  <li>&nbsp;&nbsp;&nbsp;&nbsp;case State_Idle:</li>
                  <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font style="color:lightgreen;font-style:italic;">//キーボードのSpaceキーが押されたら。</font></li>
                  <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (g_keyboard-&gt;IsKeyTrigger(Keyboard::Space))</li>
                  <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</li>
                  <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font style="color:lightgreen;font-style:italic;">//ジャンプアニメーションを再生。</font></li>
                  <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;m_modelRender.PlayAnimation(enAnimationClip_Jump);</li>
                  <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font style="color:lightgreen;font-style:italic;">//ジャンプ速度を設定。</font></li>
                  <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;m_velocity.y = JUMP_VELOCITY;</li>
                  <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font style="color:lightgreen;font-style:italic;">//ジャンプ中にする。</font></li>
                  <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;m_state = State_Jump;</li>
                  <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</li>
                  <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font style="color:lightgreen;font-style:italic;">//キーボードのFキーが押されたら。</font></li>
                  <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else if (g_keyboard-&gt;IsKeyTrigger(Keyboard::F))</li>
                  <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</li>
                  <li><font style="color:lightgreen;font-style:italic;">//.....</font></li>
                  </ol></code>
              </div>
              <div class="margin-letter">
                <span class="strong-letter">Actor::Update()のこのswitch文の処理を、Stateパターンで行うように改造してください。</span>
                <ul>
                  <li>Answerに実装例がありますので、参考にしてください。</li>
                </ul>
              </div>
            </div>
          </div>
          <li id="5"><h2 class="margin-letter2">6.5 うますぎた話</h2></li>
          <div class="letter">
            <div>
              ここまでFSMの良さを力説してきましたが、ここで一転して足元をすくわれることになります。FSMの最大の長所が最大の欠点でもあるのです。
              <br>FSMは、扱いにくい問題に対して限定的な構造を強制することで、わかりやすくするのを助けます。
              しかし、ゲームAIのような複雑なものにFSMを適用させようとすると、FSMの欠点に頭から突っ込むことになります。
              ありがたいことに、私たちの先駆者が障害のいくつかをかわす方法をいくつもみつけています。そのうちのいくつかをざっと紹介したいと思います。
              <ul>
                <div class="margin-letter">
                  <h5><li>平行状態機械</li></h5>
                  プレイヤーが銃を携行できるようにしてみましょう。
                  これまでの、「立っている」・「屈んでいる」・「ジャンプしている」状態に加え、「銃を持ちながら立っている」・「銃を持ちながら屈んでいる」・「銃を持ちながらジャンプをしている」状態を追加することになります。
                  また、武器の種類を剣・刀・槍と増やそうとすると、「剣を持ちながら立っている」・「槍を持ちながら立っている」という風に<span class="strong-letter">組み合わせ的爆発</span>を起こしてしまいます。
                  <br>このような問題が起きてしまった原因としては、2つの状態(していること・持っている物)を単一の機械(状態)に混ぜ合わせてしまったことです。
                  可能な組み合わせ全てを単一の状態としてしまっては、組み合わせの数が膨大となってしまいます。
                  <br>修正方法は簡単です。<span class="strong-letter">2つの別の状態機械を保持</span>するようにすればいいのです。
                  <div class="margin-letter">
                    <code>
                      <ol class="code-region row coll-11">
                      <li>class Actor</li>
                      <li>{</li>
                      <li>public:</li>
                      <li>&nbsp;&nbsp;&nbsp;&nbsp;<font style="color:lightgreen;font-style:italic;">//...</font></li>
                      <li>private:</li>
                      <li>&nbsp;&nbsp;&nbsp;&nbsp;ActorState*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;m_state;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font style="color:lightgreen;font-style:italic;">//プレイヤーの状態。</font></li>
                      <li>&nbsp;&nbsp;&nbsp;&nbsp;ActorState*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;m_equipment;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font style="color:lightgreen;font-style:italic;">//プレイヤーの所持している武器。</font></li>
                      <li>};</li>
                      </ol></code>
                  </div>
                  <div class="margin-letter">
                    プレイヤーが入力の処理をStateに委任する際には、両方のStateに委任させるようにします。
                  </div>
                  <div class="margin-letter">
                    <code>
                      <ol class="code-region row coll-11">
                      <li>void Actor::HandleInput()</li>
                      <li>{</li>
                      <li>&nbsp;&nbsp;&nbsp;&nbsp;m_state-&gt;HandleInput(this);</li>
                      <li>&nbsp;&nbsp;&nbsp;&nbsp;m_equipment-&gt;HandleInput(this);</li>
                      <li>}</li>
                      </ol></code>
                  </div>
                  <div class="margin-letter">
                    こうすれば、両方の状態がそれぞれ独立して入力に反応し、状態を遷移できます。
                    両方の状態が無関係であれば、これでうまくいきます。
                  </div>

                </div>
                <div class="margin-letter">
                  <h5><li>階層的状態機械</li></h5>
                    プレイヤーの振る舞いをどんどん肉付けしていくと、内容の似た状態が多くなってきます。
                    どの状態でもBボタンでジャンプ、下ボタンで屈むなどです。これらの重複した部分の実装は一度だけにして、再利用できるようにした方がいいでしょう。
                    <br>プレイヤーが「地上にいる」状態クラスを定義し、そこでジャンプと屈む状態に遷移する処理を実装します。
                    <span class="strong-letter">「立っている」・「ジャンプ」・「走っている」クラスは、それを継承した上で追加の振る舞いを実装</span>します。
                    <br>これが、<span class="strong-letter">階層的状態機械</span>と呼ばれるものになります。
                    <span class="strong-letter">それぞれの状態には親状態が存在し、子状態が入力を処理できなければ、それが親状態で受け渡され</span>ます。
                    <br>まず、以下のように親状態に相当する基底クラスを定義します。
                  <div class="margin-letter">
                    <code>
                      <ol class="code-region row coll-11">
                      <li><font style="color:lightgreen;font-style:italic;">//地上にいる状態クラス。</font></li>
                      <li>class OnGroundState : public ActorState</li>
                      <li>{</li>
                      <li>public:</li>
                      <li>&nbsp;&nbsp;&nbsp;&nbsp;virtual ActorState* HandleInput(Actor* actor)</li>
                      <li>&nbsp;&nbsp;&nbsp;&nbsp;{</li>
                      <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font style="color:lightgreen;font-style:italic;">//Bボタンが押されたら。</font></li>
                      <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (IsPressButton(B))</li>
                      <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</li>
                      <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font style="color:lightgreen;font-style:italic;">//ジャンプステートを返す。</font></li>
                      <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return new JumpingState();</li>
                      <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</li>
                      <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font style="color:lightgreen;font-style:italic;">//下ボタンが押されたら。</font></li>
                      <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else if (IsPressButton(Down))</li>
                      <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</li>
                      <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font style="color:lightgreen;font-style:italic;">//屈みステートを返す。</font></li>
                      <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return new DuckingState();</li>
                      <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</li>
                      <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font style="color:lightgreen;font-style:italic;">//...</font></li>
                      <li>&nbsp;&nbsp;&nbsp;&nbsp;}</li>
                      <li>};</li>
                      </ol></code>
                  </div>
                  <div class="margin-letter">
                      そして、それぞれの子状態がこれを継承します。
                  </div>
                  <div class="margin-letter">
                    <code>
                      <ol class="code-region row coll-11">
                      <li><font style="color:lightgreen;font-style:italic;">//屈み状態クラス。</font></li>
                      <li>class DuckingState : public OnGroundState</li>
                      <li>{</li>
                      <li>public:</li>
                      <li>&nbsp;&nbsp;&nbsp;&nbsp;virtual ActorState* HandleInput(Actor* actor)</li>
                      <li>&nbsp;&nbsp;&nbsp;&nbsp;{</li>
                      <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font style="color:lightgreen;font-style:italic;">//下ボタンが離されたら。</font></li>
                      <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (IsReleaseButton(Down))</li>
                      <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</li>
                      <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font style="color:lightgreen;font-style:italic;">//立ち状態に戻す。</font></li>
                      <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return new StandingState();</li>
                      <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</li>
                      <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font style="color:lightgreen;font-style:italic;">//入力が処理されなければ。</font></li>
                      <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else</li>
                      <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</li>
                      <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font style="color:lightgreen;font-style:italic;">//階層を遡る(親状態の
                        で実装されている処理を行う)。</font></li>
                      <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return OnGroundState::HandleInput(actor);</li>
                      <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</li>
                      <li>&nbsp;&nbsp;&nbsp;&nbsp;}</li>
                      <li>};</li>
                      </ol></code>
                  </div>
                </div>
                <div class="margin-letter">
                  <h5><li>プッシュダウン・オートマトン</li></h5>
                  先ほど、プレイヤーの武装を実装しました。銃を撃つ際には、アニメーションであったり弾丸を飛ばすなどの処理が必要なので、FiringStateを実装しました。
                  銃を撃つ際には、FiringStateに遷移するようにしました。
                  <br>問題は、発砲が終わった後にプレイヤーが遷移する状態です。
                  「立っている」・「走っている」状態にFiringStateに遷移して発砲が終われば、また「立っている」・「走っている」状態に遷移するようにしなければなりません。
                  <br>しかし、<span class="strong-letter">これまで説明したFSMには、「履歴」という概念は存在しません。</span>
                  元の「立っている」・「走っている」状態に戻すには、「立っている時に発砲」・「ジャンプしている時に発砲」という新たな状態を定義しなければなりません。
                  そうすれば、発砲が終了したときに、正しい状態に遷移することができます。
                  <br>
                  <br>しかし、私たちが本当にやりたいことは、<span class="strong-letter">発砲をする前の状態を記録し、発砲が終われば再びその状態に遷移</span>させることです。
                  この問題には、「プッシュダウン・オートマトン」が役に立ちます。
                  <br><span class="strong-letter">プレイヤーには、Stateのスタックを持たせる</span>ようにします。
                  新しいStateが生成されれば、そのStateをスタックにpushし新しい状態に遷移します。
                  逆に、元のステートに遷移させる際には、現在のStateをスタックからpopし、新しくスタックトップとなったStateを現在のStateとします。
                </div>
                <div>
                  <img src="image/5/3.png" class="margin-letter">
                </div>
              </ul>

            </div>
          </div>
        </ul>
      </div>
    </body>
</html>
